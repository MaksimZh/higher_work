# Что нам делать с ORM-ами?
Отношения многие-ко-многим и нормализованная модель данных
хорошо подходят там, где важна комбинируемость и свобода творчества.
Это полезно в различных бизнес-проектах,
где важно в динамике
добавлять новые и улучшать старые сервисы,
отстраиваться от конкурентов,
исправлять концептуальные ошибки.
При этом желательно, чтобы не приходилось каждый раз
перелопачивать всю структуру базы данных.

Например, в каршеринге одним автомобилем по очереди пользуются несколько
водителей - это отношение один автомобиль - много водителей.
Можно добавить возможность бронирования нескольких автомобилей -
вот и отношение один водитель - много автомобилей.
А ещё можно сделать семейные или корпоративные аккаунты,
тогда отношения будут не только с водителями, но и с их группами,
а один водитель иметь отношение и к семье и к какому-то юрлицу.
Вся эта комбинаторика хорошо сочетается с нормализованными данными,
которые, по сути, представляют собой граф,
для которого информация о рёбрах хранится отдельно от узлов.

Ещё более динамичный пример - игры.
Что придёт в голову гейм-дизайнерам не знают даже они сами.
Здесь даже была придумана особая форма объектов - сущности (entities),
у которых нет ничего, кроме уникального токена,
а весь функционал навешивается динамически в виде компонентов.

Другой полюс - абстрактные типы данных (АТД).
При хорошем дизайне системы свобода творчества здесь,
наоборот, максимально ограничивается
с помощью минималистичного интерфейса, который регулирует доступ к данным.
АТД хороши там, где формат взаимодействия с данными очевиден и устойчив.
Это, конечно, субъективные характеристики, но человечество уже выработало
ряд универсальных интерфейсов, которые повсеместно используются
в качестве строительных блоков:
кортежи, множества, списки, словари, очереди и т.д.
При реализации АТД отношения между данными внутри него
фиксированы, денормализованы и оптимизированы под конкретную задачу.

В случаях с каршерингом и играми обычно используются мутабельные данные,
а точнее, stateful вычислительная модель.
На каком-то уровне абстракции данные всё равно будут мутабельными,
если мы не храним их на массиве CD-R, конечно.
Другое дело - вычислительная модель.
Это тот уровень абстракций, с которым придётся работать
при проектировании и написании кода.

АТД - хорошие строительные блоки, но на каком-то уровне
нужна свобода для творчества.
И кстати, оси АТД-Нормализованные и stateless-stateful ортогональны.
Например, существуют как мутабельные, так и иммутабельные АТД.

На относительно низком уровне абстракции - в базовых модулях приложения -
лучше всего использовать statless-АТД.
Внутри каких-то отдельных функций, в целях оптимизации, например,
код может быть stateful, но он должен быть заперт внутри.
Разделение состояния между потоками и, тем более, глобальные переменные -
всё это крайне нежелательно, потому что нелокально и запутывает систему.

На каком-то уровне, где важна комбинируемость,
желательно переходить к нормализованным данным.
Обязательно ли они должны быть stateful?
Нет!
Даже работу игрового движка с компонентами в подходе ECS можно
сделать на основе map-reduce,
а уникальные stateful-сущности можно убрать в монады.

Я считаю, что ограничение stateful-кода - вопрос математики.
Монады - это только первый шаг, который позволил применять
функциональных подход там, где, казалось, от явного состояния
никуда не деться.
Это не предел.
В реактивном программировании возможно декларативное управление
потоками событий и изменений.

Так что можно придумать такие абстракции, которые
и без явного состояния, и легко комбинируются.
Вот с ними и надо заниматься свободным творчеством,
а не с ключами и таблицами в базе данных.

---

Есть у меня один проект, где это всё очень актуально.
В качестве данных там выступает графическое представление программы,
которое хранится в виде узлов и связей.
Чтобы это всё обрабатывать, нужно научить компьютер "видеть"
какие-то абстракции поверх этого простого графа.
Это подобно тому, как компилятор преобразует поток символов
в поток токенов, потом в дерево абстрактного синтаксиса,
а потом в этом дереве уже выделяет более сложные структуры.
Будет интересно!
