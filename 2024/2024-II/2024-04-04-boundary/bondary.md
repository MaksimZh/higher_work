# Справляемся с краевыми случаями

## 1. Примеры краевых случаев

### 1.1 Сингулярность
Решал уравнение Шрёдингера для электрона
вбилизи примесного атома в полупроводнике
методом матрицы рассеяния.
Для этого нужно было вычислить все частные решения системы дифуров
на каждом отрезке, на которые разбита ось радиуса
в сферических координатах.
Для всех отрезков всё решалось легко, кроме отрезка, содержащего r=0.

Вычисление решений на этом отрезке стало темой
[отдельной научной работы](https://colab.ws/articles/10.3103/S1062873823702003).
Пришлось использовать совсем другой подход - обобщённый метод Фробениуса.
До меня такое делали только
[2 французских математика](https://www.researchgate.net/publication/238792179_Frobenius_Method_for_Computing_Power_Series_Solutions_of_Linear_Higher-Order_Differential_Systems),
которые использовали символьные вычисления,
а я хотел численный алгоритм.
Ключевая часть для этого алгоритма нашлась в
[диссертации американского математика](https://escholarship.org/uc/item/4qj976xg).

Практика показала, что общее решение не так уж сильно зависит от того,
что происходит вблизи r=0.
Может проще было эту область выкинуть. 


### 1.2 Нулевая частота
Снова матрица рассеяния, но теперь уже не примеси, а многослойные структуры.
Если энергия частицы, для которой ищем решение, совпадёт с одной из зон,
то будут частные решения в виде волн с нулевой частотой.
Алгоритм, рассчитанный на волны с ненулевой частотой, падает,
потому что местами делит на ноль (или обращает сингулярные матрицы).

Решением было просто запретить частицы с такой энергией.
Там, где совпадение - просто добавляем очень маленький сдвиг,
который на остальные расчёты никак не влияет.


### 1.3 Граница поля
Ещё со школы иногда сталкиваюсь с задачами поиска пути на клетчатом поле.
На границах и в углах соседних ячеек всегда меньше чем в центре.

Чтобы не писать пачки условий для граничных ячеек, просто увеличиваем поле
и ставим за его пределами непроницаемые стенки.


### 1.4 Сечение тензора
Пусть у нас есть многомерный массив у которого оси имеют идентификаторы
и могут хранить дополнительную информацию.
Я в своём коде называю этот тип `Tensor`.

Когда мы берём сечение этого тензора (можно не по всем осям)
то получается другой тензор.
Когда мы берём каждую ось и для неё задаём ровно один индекс -
это доступ к одному элементу по индексу.
Результат этих операций имеет разный тип, хотя технически (в Python)
второе - крайний случай первого.

Решение - интерпретировать крайний случай как не крайний.
Пусть результат тоже будет тензором, но нулевого ранга
(такое в системе типов проекта разрешено).
Если мы уверены, что хотим один элемент - этот тензор нужно распаковать.
Если он не скаляр (не нулевой ранг) - тогда при распаковке
возникнет исключение.
Падение программы при логической ошибке в коде -
желаемое поведение для научных расчётов.
Лучше вовсе не получить решение,
чем получить неправильное и не знать об этом.


## 2. Более сильные идеи

### 2.1 Сингулярность
В первую очередь, при декомпозиции задачи,
нужно выделить общий алгоритм, работающий с матрицами рассеяния.
Тогда ему не важно, каким именно способом получены частные решения.
Затем, для начала, нужно подсовывать ему отрезки,
которые не содержат ноль, но приближаются к нему.
Тогда, если при приближении к нулю нет сильных изменений результата,
так и оставить там дырку.

Конечно, новый опыт и новые знания по математики того стоили,
и не раз выручали в других задачах :)


### 2.2 Нулевая частота
Здесь решение было, фактически, свести краевой случай к основному.
Поскольку в наших задачах изменение энергии на 0.0001%
на порядки меньше всех возможных погрешностей,
можно двигать энергию как хотим, лишь бы алгоритм был проще.


### 2.3 Граница поля
И здесь решение идеальное - свести краевой случай к основному.
Как говорил наш преподаватель по вычислительной математике:
> Мне не нужна Жорданова форма.
  Я добавлю случайный шум много меньше погрешности,
  и все собственные значения у меня станут разными.


### 2.4 Сечение тензора
Снова краевой случай сводится к основному.
Это, похоже, мой любимый способ обработки краевых случаев.
